<!DOCTYPE html>
<html>
<head>
  <title>WiFi Configuration - CPR Monitor</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding-top: 60px; /* Space for hamburger menu */
    }

    h1 {
      color: #4CAF50;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-size: 2rem;
    }

    .wifi-form {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #B0BEC5;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }

    input[type="text"], input[type="password"], select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input[type="text"]:focus, input[type="password"]:focus, select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    button {
      flex: 1;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: bold;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    button.secondary:hover {
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      display: none;
    }

    .status-success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }

    .status-error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #f44336;
    }

    .status-info {
      background: rgba(33, 150, 243, 0.2);
      border: 1px solid rgba(33, 150, 243, 0.3);
      color: #2196F3;
    }

    .status-warning {
      background: rgba(255, 193, 7, 0.2);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #FFC107;
    }

    /* Network Status Indicator */
    .network-status {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .network-status h3 {
      color: #4CAF50;
      margin-bottom: 10px;
    }

    .network-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .network-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 5px;
      font-size: 0.9rem;
    }

    /* Available Networks */
    /* .available-networks {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .available-networks h3 {
      color: #4CAF50;
      margin-bottom: 15px;
      text-align: center;
    }

    .network-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .network-item-list {
      background: rgba(255, 255, 255, 0.05);
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .network-item-list:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .network-name {
      font-weight: bold;
    }

    .network-signal {
      font-size: 0.8rem;
      color: #B0BEC5;
    } */

    /* Enhanced Hamburger menu styles */
    .hamburger-menu {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .menu-btn {
      display: flex;
      flex-direction: column;
      cursor: pointer;
      background: rgba(76, 175, 80, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease;
    }

    .menu-btn:hover {
      background: rgba(76, 175, 80, 0.3);
    }

    .menu-btn span {
      width: 25px;
      height: 3px;
      background: #4CAF50;
      margin: 3px 0;
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .menu-btn.active span:nth-child(1) {
      transform: rotate(-45deg) translate(-6px, 6px);
    }

    .menu-btn.active span:nth-child(2) {
      opacity: 0;
    }

    .menu-btn.active span:nth-child(3) {
      transform: rotate(45deg) translate(-6px, -6px);
    }

    .menu-content {
      display: none;
      position: absolute;
      top: 60px;
      left: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      min-width: 220px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 999;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .menu-content.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-content a {
      color: #eee;
      padding: 15px 20px;
      text-decoration: none;
      display: block;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 500;
    }

    .menu-content a:last-child {
      border-bottom: none;
    }

    .menu-content a:hover {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      padding-left: 25px;
    }

    .menu-content a.active {
      background: rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #4CAF50;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        padding-top: 70px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .wifi-form {
        padding: 20px;
      }

      .button-group {
        flex-direction: column;
      }

      .network-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Enhanced Hamburger Menu -->
  <div class="hamburger-menu">
    <div class="menu-btn" onclick="WiFiConfig.toggleMenu()" id="menuBtn">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="menu-content" id="menuContent">
      <a href="/" title="Main Dashboard">üè† CPR Dashboard</a>
      <a href="/config" title="CPR Settings">‚öôÔ∏è CPR Configuration</a>
      <a href="/ssid_config" class="active" title="WiFi Settings">üì∂ WiFi Configuration</a>
      <a href="/cloud_config" title="Cloud Settings">‚òÅÔ∏è Cloud Configuration</a>
      <a href="/data" title="Data Management">üìä Data Management</a>
    </div>
  </div>

  <div class="container">
    <h1>üì∂ WiFi Configuration</h1>

    <!-- Network Status Display -->
    <div class="network-status" id="networkStatus">
      <h3>Current Network Status</h3>
      <div id="networkInfo" class="network-info">
        <div class="network-item">
          <strong>Status:</strong> <span id="connectionStatus">Checking...</span>
        </div>
        <div class="network-item">
          <strong>SSID:</strong> <span id="currentSSID">--</span>
        </div>
        <div class="network-item">
          <strong>Signal:</strong> <span id="signalStrength">--</span>
        </div>
        <div class="network-item">
          <strong>IP:</strong> <span id="ipAddress">--</span>
        </div>
      </div>
    </div>

    <!-- Available Networks -->
    <!-- <div class="available-networks">
      <h3>üì° Available Networks</h3>
      <button class="secondary" onclick="WiFiConfig.scanNetworks()" id="scanBtn">
        üîç Scan for Networks
      </button>
      <div id="networkList" class="network-list">
        <div style="text-align: center; color: #B0BEC5; padding: 20px;">
          Click "Scan for Networks" to find available WiFi networks
        </div>
      </div>
    </div> -->

    <!-- WiFi Configuration Form -->
    <form class="wifi-form" id="wifiForm" onsubmit="return false;">
      <div class="form-group">
        <label for="ssid">WiFi Network Name (SSID)</label>
        <input type="text" id="ssid" name="ssid" placeholder="Enter WiFi network name" required>
      </div>

      <div class="form-group">
        <label for="password">WiFi Password</label>
        <input type="password" id="password" name="password" placeholder="Enter WiFi password" required>
      </div>

      <div class="button-group">
        <button type="button" onclick="WiFiConfig.saveWifiConfig()" id="saveBtn">
          üíæ Save & Connect
        </button>
        <button type="button" class="secondary" onclick="WiFiConfig.testConnection()" id="testBtn">
          üîó Test Connection
        </button>
      </div>

      <div id="statusMessage" class="status-message"></div>
    </form>

    <!-- Additional Info -->
    <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px;">
      <h4 style="color: #FFC107; margin-bottom: 10px;">‚ÑπÔ∏è Important Notes:</h4>
      <ul style="color: #FFC107; font-size: 0.9rem; line-height: 1.6;">
        <li>The device will automatically connect to WiFi after saving valid credentials</li>
        <li>The hotspot will remain active for configuration access</li>
        <li>If connection fails, you can still access this page via the hotspot</li>
        <li>Strong signal strength (-50dBm or higher) is recommended for reliable operation</li>
      </ul>
    </div>
  </div>

  <script>
    // =============================================
    // WIFI CONFIGURATION MODULE (NAMESPACED)
    // =============================================
    const WiFiConfig = (function() {
      // Private variables
      let menuOpen = false;
      // let isScanning = false;
      let isConnecting = false;

      // =============================================
      // UTILITY FUNCTIONS
      // =============================================
      function showStatus(message, type = 'info', duration = 5000) {
        const statusEl = document.getElementById("statusMessage");
        
        // Remove all status classes
        statusEl.classList.remove('status-success', 'status-error', 'status-info', 'status-warning');
        
        // Add appropriate class and message
        statusEl.classList.add(`status-${type}`);
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        
        console.log(`üì± Status [${type}]: ${message}`);
        
        // Auto-hide after duration (unless it's a loading message)
        if (duration > 0 && !message.includes('...')) {
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, duration);
        }
      }

      // function getSignalBars(rssi) {
      //   if (rssi >= -50) return 'üì∂üì∂üì∂üì∂'; // Excellent
      //   if (rssi >= -60) return 'üì∂üì∂üì∂'; // Good
      //   if (rssi >= -70) return 'üì∂üì∂'; // Fair
      //   if (rssi >= -80) return 'üì∂'; // Poor
      //   return 'üìµ'; // Very poor
      // }

      function resetButtons() {
        isConnecting = false;
        
        const saveBtn = document.getElementById('saveBtn');
        const testBtn = document.getElementById('testBtn');
        
        saveBtn.disabled = false;
        testBtn.disabled = false;
        saveBtn.innerHTML = 'üíæ Save & Connect';
      }

      // =============================================
      // MENU FUNCTIONS
      // =============================================
      function toggleMenu() {
        const menuContent = document.getElementById("menuContent");
        const menuBtn = document.getElementById("menuBtn");
        
        menuOpen = !menuOpen;
        
        if (menuOpen) {
          menuContent.classList.add("show");
          menuBtn.classList.add("active");
        } else {
          menuContent.classList.remove("show");
          menuBtn.classList.remove("active");
        }
        
        console.log('üì± Menu toggled:', menuOpen ? 'open' : 'closed');
      }

      // =============================================
      // NETWORK STATUS FUNCTIONS
      // =============================================
      function updateNetworkStatus() {
        showStatus("Checking network status...", "info", 0);
        
        fetch('/network_status', {
          method: 'GET',
          cache: 'no-cache'
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('üì° Network status:', data);
          
          // Update status display
          document.getElementById('connectionStatus').textContent = 
            data.wifi_connected ? '‚úÖ Connected' : '‚ùå Disconnected';
          
          document.getElementById('currentSSID').textContent = 
            data.wifi_ssid || '--';
          
          document.getElementById('signalStrength').textContent = 
            data.wifi_rssi ? `${data.wifi_rssi} dBm` : '--';
          
          document.getElementById('ipAddress').textContent = 
            data.ip_address || '--';
          
          if (data.wifi_connected) {
            showStatus(`‚úÖ Connected to "${data.wifi_ssid}" with signal ${data.wifi_rssi} dBm`, "success");
          } else {
            showStatus("‚ùå Not connected to WiFi", "warning");
          }
        })
        .catch(error => {
          console.error('üì° Network status error:', error);
          showStatus(`‚ùå Error checking network status: ${error.message}`, "error");
          
          // Set default values
          document.getElementById('connectionStatus').textContent = 'Error';
          document.getElementById('currentSSID').textContent = '--';
          document.getElementById('signalStrength').textContent = '--';
          document.getElementById('ipAddress').textContent = '--';
        });
      }

      // =============================================
      // NETWORK SCANNING FUNCTIONS
      // =============================================
      // function scanNetworks() {
      //   if (isScanning) {
      //     console.log('üì° Scan already in progress');
      //     return;
      //   }
        
      //   isScanning = true;
      //   const scanBtn = document.getElementById('scanBtn');
      //   const networkList = document.getElementById('networkList');
        
      //   // Update button state
      //   scanBtn.disabled = true;
      //   scanBtn.innerHTML = '<span class="loading"></span>Scanning...';
        
      //   // Show scanning message
      //   networkList.innerHTML = '<div style="text-align: center; color: #2196F3; padding: 20px;"><span class="loading"></span>Scanning for networks...</div>';
        
      //   showStatus("üîç Scanning for available WiFi networks...", "info", 0);
        
      //   fetch('/scan_networks', {
      //     method: 'POST',
      //     headers: {
      //       'Content-Type': 'application/json'
      //     },
      //     cache: 'no-cache'
      //   })
      //   .then(response => {
      //     if (!response.ok) {
      //       throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      //     }
      //     return response.json();
      //   })
      //   .then(data => {
      //     console.log('üì° Scan results:', data);
          
      //     if (data.success && data.networks && data.networks.length > 0) {
      //       displayNetworks(data.networks);
      //       showStatus(`‚úÖ Found ${data.networks.length} networks`, "success");
      //     } else {
      //       networkList.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">‚ùå No networks found</div>';
      //       showStatus("‚ùå No networks found", "warning");
      //     }
      //   })
      //   .catch(error => {
      //     console.error('üì° Scan error:', error);
      //     networkList.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">‚ùå Scan failed</div>';
      //     showStatus(`‚ùå Scan failed: ${error.message}`, "error");
      //   })
      //   .finally(() => {
      //     // Reset button state
      //     isScanning = false;
      //     scanBtn.disabled = false;
      //     scanBtn.innerHTML = 'üîç Scan for Networks';
      //   });
      // }

      // function displayNetworks(networks) {
      //   const networkList = document.getElementById('networkList');
        
      //   if (networks.length === 0) {
      //     networkList.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">No networks available</div>';
      //     return;
      //   }
        
      //   // Sort networks by signal strength (higher RSSI = stronger signal)
      //   networks.sort((a, b) => (b.rssi || -100) - (a.rssi || -100));
        
      //   let html = '';
      //   networks.forEach(network => {
      //     const signalStrength = network.rssi || -100;
      //     const signalBars = getSignalBars(signalStrength);
      //     const security = network.auth_mode > 0 ? 'üîí' : 'üîì';
          
      //     html += `
      //       <div class="network-item-list" onclick="WiFiConfig.selectNetwork('${network.ssid}', ${network.auth_mode})">
      //         <div>
      //           <div class="network-name">${security} ${network.ssid}</div>
      //           <div style="font-size: 0.8rem; color: #B0BEC5;">
      //             ${network.auth_mode > 0 ? 'Secured' : 'Open'} ‚Ä¢ Channel ${network.channel || 'Unknown'}
      //           </div>
      //         </div>
      //         <div class="network-signal">
      //           ${signalBars} ${signalStrength} dBm
      //         </div>
      //       </div>
      //     `;
      //   });
        
      //   networkList.innerHTML = html;
      // }

      // function selectNetwork(ssid, authMode) {
      //   console.log(`üì° Selected network: ${ssid} (auth: ${authMode})`);
        
      //   document.getElementById('ssid').value = ssid;
        
      //   // Focus on password field if network is secured
      //   if (authMode > 0) {
      //     document.getElementById('password').focus();
      //     showStatus(`üîê Enter password for "${ssid}"`, "info");
      //   } else {
      //     showStatus(`‚úÖ Selected open network "${ssid}"`, "success");
      //   }
      // }

      // =============================================
      // CONNECTION FUNCTIONS
      // =============================================
      function saveWifiConfig() {
        if (isConnecting) {
          console.log('üì° Connection already in progress');
          return;
        }
        
        const ssid = document.getElementById('ssid').value.trim();
        const password = document.getElementById('password').value;
        
        if (!ssid) {
          showStatus("‚ùå Please enter a WiFi network name", "error");
          document.getElementById('ssid').focus();
          return;
        }
        
        isConnecting = true;
        const saveBtn = document.getElementById('saveBtn');
        const testBtn = document.getElementById('testBtn');
        
        // Update button states
        saveBtn.disabled = true;
        testBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading"></span>Connecting...';
        
        showStatus("üíæ Saving WiFi configuration and connecting...", "info", 0);
        
        const wifiConfig = {
          ssid: ssid,
          password: password
        };
        
        fetch('/save_wifi_config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(wifiConfig)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('üì° WiFi config response:', data);
          
          if (data.success) {
            showStatus("‚úÖ WiFi configuration saved! Attempting to connect...", "success");
            
            // Start monitoring connection status
            setTimeout(() => {
              monitorConnection(ssid);
            }, 3000);
            
          } else {
            throw new Error(data.error || 'Unknown error occurred');
          }
        })
        .catch(error => {
          console.error('üì° WiFi config error:', error);
          showStatus(`‚ùå Error saving WiFi config: ${error.message}`, "error");
          
          // Reset button states
          resetButtons();
        });
      }

      function monitorConnection(expectedSSID, attempts = 0) {
        const maxAttempts = 10; // 30 seconds total
        
        if (attempts >= maxAttempts) {
          showStatus(`‚ùå Connection timeout. Please check credentials and try again.`, "error");
          resetButtons();
          return;
        }
        
        showStatus(`üîÑ Checking connection... (${attempts + 1}/${maxAttempts})`, "info", 0);
        
        fetch('/network_status', {
          method: 'GET',
          cache: 'no-cache'
        })
        .then(response => response.json())
        .then(data => {
          console.log(`üì° Connection check ${attempts + 1}:`, data);
          
          if (data.wifi_connected && data.wifi_ssid === expectedSSID) {
            // Success!
            showStatus(`üéâ Successfully connected to "${expectedSSID}"! Signal: ${data.wifi_rssi} dBm`, "success");
            updateNetworkStatus();
            resetButtons();
          } else if (data.wifi_connected && data.wifi_ssid !== expectedSSID) {
            // Connected to different network
            showStatus(`‚ö†Ô∏è Connected to "${data.wifi_ssid}" instead of "${expectedSSID}"`, "warning");
            updateNetworkStatus();
            resetButtons();
          } else {
            // Still trying to connect
            setTimeout(() => {
              monitorConnection(expectedSSID, attempts + 1);
            }, 3000);
          }
        })
        .catch(error => {
          console.error(`üì° Connection check ${attempts + 1} error:`, error);
          setTimeout(() => {
            monitorConnection(expectedSSID, attempts + 1);
          }, 3000);
        });
      }

      function testConnection() {
        const ssid = document.getElementById('ssid').value.trim();
        const password = document.getElementById('password').value;
        
        if (!ssid) {
          showStatus("‚ùå Please enter a WiFi network name", "error");
          document.getElementById('ssid').focus();
          return;
        }
        
        showStatus("üîó Testing WiFi connection...", "info", 0);
        
        const testBtn = document.getElementById('testBtn');
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="loading"></span>Testing...';
        
        const wifiConfig = {
          ssid: ssid,
          password: password
        };
        
        fetch('/test_wifi_connection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(wifiConfig)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showStatus(`‚úÖ Connection test successful! Signal: ${data.rssi} dBm`, "success");
          } else {
            showStatus(`‚ùå Connection test failed: ${data.error}`, "error");
          }
        })
        .catch(error => {
          console.error('üì° Test connection error:', error);
          showStatus(`‚ùå Test failed: ${error.message}`, "error");
        })
        .finally(() => {
          testBtn.disabled = false;
          testBtn.innerHTML = 'üîó Test Connection';
        });
      }

      // =============================================
      // INITIALIZATION
      // =============================================
      function init() {
        console.log('üì± WiFi Configuration module initialized');
        
        // Load initial network status
        updateNetworkStatus();
        
        // Load existing WiFi config if available
        fetch('/get_wifi_config')
          .then(response => {
            if (response.ok) {
              return response.json();
            }
            throw new Error('No existing config');
          })
          .then(data => {
            if (data.ssid) {
              document.getElementById('ssid').value = data.ssid;
              console.log('üì° Loaded existing SSID:', data.ssid);
            }
          })
          .catch(error => {
            console.log('‚ÑπÔ∏è No existing WiFi config found');
          });

        // Set up event listeners
        setupEventListeners();
      }

      function setupEventListeners() {
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
          const hamburgerMenu = document.querySelector('.hamburger-menu');
          
          if (!hamburgerMenu.contains(event.target) && menuOpen) {
            toggleMenu();
          }
        });

        // Prevent menu close when clicking inside menu
        document.getElementById("menuContent").addEventListener('click', function(event) {
          event.stopPropagation();
        });

        // Form submission handling
        document.getElementById('wifiForm').addEventListener('submit', function(e) {
          e.preventDefault();
          saveWifiConfig();
        });

        // Enter key handling for password field
        document.getElementById('password').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            saveWifiConfig();
          }
        });
      }

      // =============================================
      // PUBLIC API
      // =============================================
      return {
        // Menu functions
        toggleMenu: toggleMenu,
        
        // Network functions
        updateNetworkStatus: updateNetworkStatus,
        // scanNetworks: scanNetworks,
        // selectNetwork: selectNetwork,
        
        // Configuration functions
        saveWifiConfig: saveWifiConfig,
        testConnection: testConnection,
        
        // Utility functions
        resetButtons: resetButtons,
        
        // Initialization
        init: init,
        
        // Status for debugging
        getStatus: function() {
          return {
            menuOpen: menuOpen,
            // isScanning: isScanning,
            isConnecting: isConnecting
          };
        }
      };
    })();

    // =============================================
    // GLOBAL INITIALIZATION
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üì± WiFi Configuration page loaded');
      WiFiConfig.init();
    });

    // =============================================
    // GLOBAL ERROR HANDLER
    // =============================================
    window.addEventListener('error', function(event) {
      console.error('üì± Global error:', event.error);
      
      const statusEl = document.getElementById("statusMessage");
      if (statusEl) {
        statusEl.classList.remove('status-success', 'status-error', 'status-info', 'status-warning');
        statusEl.classList.add('status-error');
        statusEl.textContent = 'An unexpected error occurred. Please refresh the page.';
        statusEl.style.display = 'block';
      }
    });

    // =============================================
    // DEBUG FUNCTIONS (GLOBAL SCOPE)
    // =============================================
    window.WiFiConfigDebug = {
      getModule: () => WiFiConfig,
      // testScan: () => WiFiConfig.scanNetworks(),
      testStatus: () => WiFiConfig.updateNetworkStatus(),
      getStatus: () => WiFiConfig.getStatus(),
      resetAll: () => {
        WiFiConfig.resetButtons();
        const statusEl = document.getElementById("statusMessage");
        statusEl.style.display = 'none';
      }
    };

    console.log('üì± WiFi Configuration Debug Commands:');
    // console.log('- WiFiConfigDebug.testScan() - Test network scanning');
    console.log('- WiFiConfigDebug.testStatus() - Test status update');
    console.log('- WiFiConfigDebug.getStatus() - Get current status');
    console.log('- WiFiConfigDebug.resetAll() - Reset all states');
  </script>
</body>
</html>